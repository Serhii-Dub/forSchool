<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WebXR AR — Модель Машини</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <script type="module">
    import * as THREE from 'three';
    import { ARButton } from 'three/addons/webxr/ARButton.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let camera, scene, renderer;
    let carModel = null;
    let modelPlaced = false;
    let hitTestSource = null;
    let localSpace = null;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Світло
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.2);
      scene.add(hemiLight);

      // ARButton
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Завантаження моделі
      const loader = new GLTFLoader();
      loader.load('car/car2.glb',
        function (gltf) {
          carModel = gltf.scene;
          // Дефолтний масштаб
          carModel.scale.set(0.5, 0.5, 0.5);
          // Початкова позиція — не має значення, все одно зміниться, але для надійності
          carModel.position.set(0, 0.2, -0.5);
          carModel.visible = false;
          scene.add(carModel);
        },
        undefined,
        function (error) {
          console.error("GLB loading error:", error);
        }
      );

      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    renderer.xr.addEventListener('sessionstart', async () => {
      const session = renderer.xr.getSession();
      try {
        const viewerRefSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerRefSpace });
        localSpace = await session.requestReferenceSpace('local');
        modelPlaced = false;
        if (carModel) carModel.visible = false;
      } catch (e) {
        console.error("WebXR hit-test error:", e);
      }
    });

    renderer.xr.addEventListener('sessionend', () => {
      hitTestSource = null;
      localSpace = null;
      modelPlaced = false;
      if (carModel) carModel.visible = false;
    });

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      if (
        renderer.xr.isPresenting &&
        hitTestSource &&
        frame &&
        !modelPlaced &&
        carModel
      ) {
        const referenceSpace = localSpace;
        const hitTestResults = frame.getHitTestResults(hitTestSource);

        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(referenceSpace);

          carModel.position.set(
            pose.transform.position.x,
            pose.transform.position.y + 0.2, // 20 см над підлогою
            pose.transform.position.z
          );
          carModel.quaternion.set(
            pose.transform.orientation.x,
            pose.transform.orientation.y,
            pose.transform.orientation.z,
            pose.transform.orientation.w
          );
          carModel.visible = true;
          modelPlaced = true;
        }
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
