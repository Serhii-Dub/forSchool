<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>AR Машина</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <script type="module">
    import * as THREE from 'three';
    import { ARButton } from 'three/addons/webxr/ARButton.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
    let renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

    scene.add(new THREE.HemisphereLight(0xffffff, 0x888888, 1.2));

    let carModel = null, modelPlaced = false, hitTestSource = null, localSpace = null;

    new GLTFLoader().load('car/car2.glb', gltf => {
      carModel = gltf.scene;
      carModel.scale.set(2, 2, 2); // змінюй за потребою
      carModel.visible = false;
      scene.add(carModel);
    });

    renderer.xr.addEventListener('sessionstart', async () => {
      let session = renderer.xr.getSession();
      let viewerSpace = await session.requestReferenceSpace('viewer');
      hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
      localSpace = await session.requestReferenceSpace('local');
      modelPlaced = false;
      if (carModel) carModel.visible = false;
    });

    renderer.xr.addEventListener('sessionend', () => {
      hitTestSource = null; localSpace = null; modelPlaced = false;
      if (carModel) carModel.visible = false;
    });

    renderer.setAnimationLoop((_, frame) => {
      if (renderer.xr.isPresenting && hitTestSource && frame && !modelPlaced && carModel) {
        let results = frame.getHitTestResults(hitTestSource);
        if (results.length > 0) {
          let pose = results[0].getPose(localSpace);
          carModel.position.set(
            pose.transform.position.x,
            pose.transform.position.y + 0.2, // піднімаємо над підлогою
            pose.transform.position.z
          );
          carModel.quaternion.set(
            pose.transform.orientation.x,
            pose.transform.orientation.y,
            pose.transform.orientation.z,
            pose.transform.orientation.w
          );
          carModel.visible = true;
          modelPlaced = true;
        }
      }
      renderer.render(scene, camera);
    });
  </script>
</body>
</html>
