<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WebXR AR — Модель Машини</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; }
    #placeholder {
      background: linear-gradient(135deg, #f0f3fa 0%, #dde6f4 100%);
      color: #232363;
      font-family: 'Segoe UI', Arial, sans-serif;
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0; left: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 2em;
      z-index: 10;
      text-align: center;
      transition: opacity 0.3s;
    }
    #placeholder img {
      width: 120px;
      margin-bottom: 24px;
      opacity: 0.7;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <!-- Простий плейсхолдер до запуску AR -->
  <div id="placeholder">
    <img src="https://cdn-icons-png.flaticon.com/512/1699/1699636.png" alt="AR" />
    <div>Щоб почати AR, натисни кнопку нижче</div>
    <small style="font-size: 0.6em; margin-top: 16px; color: #647199;">Дозволь доступ до камери.<br>Модель авто з'явиться у просторі!</small>
  </div>
  <script type="module">
    import * as THREE from 'three';
    import { ARButton } from 'three/addons/webxr/ARButton.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let camera, scene, renderer;
    let carModel = null;
    let modelPlaced = false;
    let hitTestSource = null;
    let localSpace = null;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Стандартна AR-кнопка від three.js
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Світло
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.2);
      scene.add(hemiLight);

      // Завантаження моделі
      const loader = new GLTFLoader();
      loader.load('car/car2.glb',
        function (gltf) {
          carModel = gltf.scene;
          carModel.scale.set(2, 2, 2); // Дуже великий розмір для надійності
          carModel.position.set(0, 1, -2);
          carModel.visible = false;
          scene.add(carModel);
        },
        undefined,
        function (error) {
          console.error("GLB loading error:", error);
        }
      );

      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      // Не міняємо розмір, якщо AR-сесія активна (щоб не було помилки)
      if (!renderer.xr.isPresenting) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    }

    renderer.xr.addEventListener('sessionstart', async () => {
      // При старті AR — ховаємо плейсхолдер
      const ph = document.getElementById('placeholder');
      if (ph) ph.style.opacity = 0, setTimeout(()=>ph.remove(),300);
      const session = renderer.xr.getSession();
      try {
        const viewerRefSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerRefSpace });
        localSpace = await session.requestReferenceSpace('local');
        modelPlaced = false;
        if (carModel) carModel.visible = false;
      } catch (e) {
        console.error("WebXR hit-test error:", e);
      }
    });

    renderer.xr.addEventListener('sessionend', () => {
      hitTestSource = null;
      localSpace = null;
      modelPlaced = false;
      if (carModel) carModel.visible = false;
    });

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      if (
        renderer.xr.isPresenting &&
        hitTestSource &&
        frame &&
        !modelPlaced &&
        carModel
      ) {
        const referenceSpace = localSpace;
        const hitTestResults = frame.getHitTestResults(hitTestSource);

        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(referenceSpace);

          carModel.position.set(
            pose.transform.position.x,
            pose.transform.position.y + 1,
            pose.transform.position.z
          );
          carModel.quaternion.set(
            pose.transform.orientation.x,
            pose.transform.orientation.y,
            pose.transform.orientation.z,
            pose.transform.orientation.w
          );
          carModel.visible = true;
          modelPlaced = true;
        }
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
